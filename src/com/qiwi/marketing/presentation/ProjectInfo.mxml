<?xml version="1.0"?>
<!--
  Created by v.pavkin on 18.04.2014.
-->
<s:Panel xmlns:s="library://ns.adobe.com/flex/spark"
		 xmlns:fx="http://ns.adobe.com/mxml/2009"
		 creationComplete="onCreationComplete()"
		 title="Project Info"
		 height="100%" width="100%"
		 skinClass="com.qiwi.marketing.presentation.skins.BigPanelSkin">

	<fx:Script><![CDATA[
		import com.qiwi.marketing.data.importing.CSVVisitsImporter;
		import com.qiwi.marketing.data.storage.LocalStorage;
		import com.qiwi.marketing.project.Project;

		import mx.containers.ViewStack;
		import mx.events.FlexEvent;

		[Bindable]
		private var _localStorage:LocalStorage = LocalStorage.instance;

		[Bindable]
		private var _project:Project;

		[Bindable]
		private var vsView:DisplayObject;

		public function onCreationComplete():void {

			var obj:DisplayObject = this;
			while (obj.parent != obj) {
				if (obj.parent is ViewStack) {
					vsView = obj;
					break;
				}
				obj = obj.parent;
			}

			if (vsView) {
				vsView.addEventListener(FlexEvent.SHOW, update, false, 0, true);
			}

			update();
		}

		private function update(e:Event = null):void {
			title = "Project Info: '" + Context.currentProject.displayName + "'";
			_project = Context.currentProject
			var dts:String = "";
			for (var d:String in _project.visits) {
				dts += d + "\n";
			}
			datesAvailable.text = dts;
			trace("INFO INIT HANDLER")
		}


		private function onImportVisitsClick():void {
			var file:File = new File();
			file.browseForOpen("Load CSV Transactions", [new FileFilter("CSV-file", "*.csv")])
			file.addEventListener(Event.SELECT, onCSVFileSelected)
		}

		private function onCSVFileSelected(event:Event):void {
			CSVVisitsImporter.importToLocalStorage(File(event.target));
		}

		private function onBackButtonClick():void {
			dispatchEvent(new Event("open_board", true));
		}
		]]></fx:Script>

	<s:HGroup gap="20">
		<s:VGroup gap="10" paddingTop="15" width="40%">
			<s:Label text="Statistics available for:" fontWeight="bold"/>
			<s:Label id="datesAvailable"/>
			<s:Button label="Back to board" click="onBackButtonClick()"/>
		</s:VGroup>
		<s:VGroup gap="15" paddingTop="15">
			<s:Button id="importVisits" click="onImportVisitsClick()" label="Load New Data"/>
		</s:VGroup>
	</s:HGroup>
</s:Panel>
